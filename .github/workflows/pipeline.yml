name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select deployment environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
###################################################
# CI STAGE - .NET BACKEND
###################################################
  dotnet-ci:
    name: .NET Backend CI
    uses: abdosaad203/centralized-automation-mid/.github/workflows/dotnet.yml@main
    permissions:
      contents: read
      packages: write
      security-events: write
      actions: read
    with:
      dotnet-version: "8.0.x"
      project-path: "backend"
      build-configuration: "Release"
      run-tests: false
    secrets: inherit

###################################################
# CI STAGE - REACT FRONTEND
###################################################
  react-ci:
    name: React Frontend CI
    runs-on: ubuntu-latest
    needs: dotnet-ci
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Build React app
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_BASE_URL: http://localhost:8080/api

      - name: Run GitLeaks scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          report-format: sarif
          report-path: gitleaks.sarif
        continue-on-error: true

      - name: Upload GitLeaks report
        if: hashFiles('gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
          category: gitleaks

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: codeql-javascript

      - name: Build & Push React Docker Image
        uses: abdosaad203/centralized-automation-mid/.github/actions/react-docker-s2i@main
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          image_name: ${{ github.repository }}/frontend
          tag: latest

      - name: Scan React image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/frontend:latest
          format: sarif
          output: trivy-react.sarif
        continue-on-error: true

      - name: Upload Trivy report
        if: hashFiles('trivy-react.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-react.sarif
          category: trivy-react

###################################################
# CD STAGE - REACT TO RAILWAY
###################################################
  deploy-react-railway:
    name: Deploy React to Railway
    runs-on: ubuntu-latest
    needs: react-ci
    if: ${{ inputs.environment != 'dev' }}
    environment: ${{ inputs.environment }}
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Set React environment variables
        run: |
          railway variables --service frontend \
            --set NODE_ENV=production \
            --set VITE_API_BASE_URL=https://${{ vars.RAILWAY_DOTNET_URL }}

      - name: Deploy React Service
        run: railway up --service frontend

###################################################
# CD STAGE - DOTNET TO RAILWAY
###################################################
  deploy-dotnet-railway:
    name: Deploy .NET Backend to Railway
    runs-on: ubuntu-latest
    needs: dotnet-ci
    if: ${{ inputs.environment != 'dev' }}
    environment: ${{ inputs.environment }}
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: dotnet-build
          path: backend

      - name: Remove gitignore to allow dll upload
        run: find . -name ".gitignore" -type f -delete

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Set Backend environment variables
        run: |
          railway variables --service backend \
            --set ASPNETCORE_ENVIRONMENT=Production \
            --set DB_HOST=${{ vars.DB_HOST }} \
            --set DB_PORT=${{ vars.DB_PORT }} \
            --set DB_NAME=${{ vars.DB_NAME }} \
            --set DB_USER=${{ vars.DB_USER }} \
            --set DB_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}

      - name: Deploy Backend Service
        run: railway up --service backend

###################################################
# CD STAGE - DEPLOY TO DEV (ANSIBLE)
###################################################
  deploy-dev:
    name: Deploy to Dev (Local with Ansible)
    runs-on: [self-hosted, linux]
    needs:
      - dotnet-ci
      - react-ci
    if: ${{ inputs.environment == 'dev' }}
    environment: dev

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¨Ù†ÙŠØ© (Ø§Ù„Ø´Ø­Ù†Ø©)
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: dotnet-build
          path: backend

      # 2. Ø®Ø·ÙˆØ© Ø§Ù„ØªØ£ÙƒØ¯ (Debug): Ø¹Ø´Ø§Ù† Ù†Ø´ÙˆÙ Ø¨Ø¹ÙŠÙ†Ù†Ø§ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ„Ø§ Ù„Ø£
      - name: List files in backend (Debug)
        run: ls -R backend/

      # 3. ğŸ”¥ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ: Ù…Ø³Ø­ Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¬Ø§Ù‡Ù„ Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙˆÙƒØ± Ù…Ø§ÙŠØªØ¬Ø§Ù‡Ù„Ø´ Ø§Ù„Ù€ DLLs
      - name: Remove ignore files
        run: |
          find backend -name ".dockerignore" -type f -delete
          find backend -name ".gitignore" -type f -delete

      # 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†Ø³Ø¨Ù„
      - name: Run Ansible Playbook
        run: |
          ansible-playbook playbook.yml \
            -e github_actor=${{ github.actor }} \
            -e github_token=${{ secrets.GITHUB_TOKEN }} \
            -e mysql_root_password=${{ secrets.MYSQL_ROOT_PASSWORD }} \
            -e db_name=${{ vars.DB_NAME }} \
            -e db_user=${{ vars.DB_USER }} \
            -e db_port=${{ vars.DB_PORT }} \
            -e db_host=${{ vars.DB_HOST }}