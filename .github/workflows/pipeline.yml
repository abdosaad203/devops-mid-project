name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select deployment environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

###################################################
# CI STAGE - .NET BACKEND
###################################################
jobs:
  dotnet-ci:
    name: .NET Backend CI
    uses: abdosaad203/centralized-automation-mid/.github/workflows/dotnet.yml@main
    permissions:
      contents: read
      packages: write
      security-events: write
    with:
      dotnet-version: "8.0.x"
      project-path: "backend"
      build-configuration: "Release"
      run-tests: false
    secrets: inherit

###################################################
# CI STAGE - REACT FRONTEND
###################################################
  react-ci:
    name: React Frontend CI
    runs-on: ubuntu-latest
    needs: dotnet-ci
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Build React app
        working-directory: frontend
        run: npm run build

      - name: Run GitLeaks scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          report-format: sarif
          report-path: gitleaks.sarif
        continue-on-error: true

      - name: Upload GitLeaks report
        if: steps.gitleaks.outcome == 'failure'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
          category: gitleaks

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: codeql-javascript

      - name: Build & Push React Docker Image
        uses: abdosaad203/centralized-automation-mid/.github/actions/react-docker-s2i@main
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          image_name: ${{ github.repository }}/frontend
          tag: latest
          api-base-url: http://localhost:8080

      - name: Scan React image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/frontend:latest
          format: sarif
          output: trivy-react.sarif
        continue-on-error: true

      - name: Upload Trivy report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-react.sarif
          category: trivy-react

###################################################
# CD STAGE - REACT TO RAILWAY
###################################################
  deploy-react-railway:
    name: Deploy React to Railway
    runs-on: ubuntu-latest
    needs: react-ci
    if: ${{ inputs.environment != 'dev' }}
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Railway Login
        run: railway login --token ${{ secrets.RAILWAY_TOKEN }}

      - name: Set React environment variables
        run: |
          railway variables set --service frontend \
            NODE_ENV=production \
            VITE_API_BASE_URL=https://${{ vars.RAILWAY_DOTNET_URL }}

      - name: Deploy React Service
        run: railway up --service frontend

###################################################
# CD STAGE - DOTNET TO RAILWAY
###################################################
  deploy-dotnet-railway:
    name: Deploy .NET Backend to Railway
    runs-on: ubuntu-latest
    needs: dotnet-ci
    if: ${{ inputs.environment != 'dev' }}
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: dotnet-build
          path: backend

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Railway Login
        run: railway login --token ${{ secrets.RAILWAY_TOKEN }}

      - name: Set Backend environment variables
        run: |
          railway variables set --service backend \
            ASPNETCORE_ENVIRONMENT=Production \
            DB_HOST=${{ vars.DB_HOST }} \
            DB_PORT=${{ vars.DB_PORT }} \
            DB_NAME=${{ vars.DB_NAME }} \
            DB_USER=${{