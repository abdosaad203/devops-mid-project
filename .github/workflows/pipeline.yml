name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select deployment environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

###################################################
# CI STAGE - .NET BACKEND
###################################################
jobs:
  dotnet-ci:
    uses: abdosaad203/centralized-automation-mid/.github/workflows/dotnet.yml@main
    with:
      dotnet-version: "8.0.x"
      project-path: "backend"
      build-configuration: "Release"
      run-tests: false


###################################################
# CI STAGE - REACT FRONTEND
###################################################
  react-ci:
    name: React Frontend CI
    runs-on: ubuntu-latest
    needs: dotnet-ci

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # 3️⃣ Install dependencies
      - name: Install dependencies
        working-directory: frontend
        run: npm install

      # 4️⃣ Build React app
      - name: Build React app
        working-directory: frontend
        run: npm run build

      # 5️⃣ GitLeaks Scan
      - name: Run GitLeaks scan
        uses: gitleaks/gitleaks-action@v2
        with:
          report-format: sarif
          report-path: gitleaks.sarif
        continue-on-error: true

      - name: Upload GitLeaks report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

      # 6️⃣ CodeQL Analysis
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # 7️⃣ Build & Push React Image (Custom S2I Action)
      - name: Build & Push React Docker Image
        uses: abdosaad203/centralized-automation-mid/.github/actions/react-docker-s2i@main
        with:
          image_name: ghcr.io/${{ github.repository }}/frontend
          context: frontend
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # 8️⃣ Trivy Image Scan
      - name: Scan React image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/frontend:latest
          format: sarif
          output: trivy-react.sarif
        continue-on-error: true

      - name: Upload Trivy report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-react.sarif


###################################################
# CD STAGE - REACT TO RAILWAY
###################################################
  deploy-react-railway:
    name: Deploy React to Railway
    runs-on: ubuntu-latest
    needs: react-ci
    if: ${{ inputs.environment != 'dev' }}
    environment: ${{ inputs.environment }}

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install Railway CLI
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # 3️⃣ Railway Login
      - name: Railway Login
        run: railway login --token $RAILWAY_TOKEN
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # 4️⃣ Set React environment variables
      - name: Set React environment variables
        run: |
          railway variables set \
            NODE_ENV=production \
            VITE_API_BASE_URL=https://${{ vars.RAILWAY_DOTNET_URL }}

      # 5️⃣ Deploy React Service
      - name: Deploy React to Railway
        run: railway up --service frontend


###################################################
# CD STAGE - DOTNET TO RAILWAY
###################################################
  deploy-dotnet-railway:
    name: Deploy .NET Backend to Railway
    runs-on: ubuntu-latest
    needs: dotnet-ci
    if: ${{ inputs.environment != 'dev' }}
    environment: ${{ inputs.environment }}

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install Railway CLI
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # 3️⃣ Railway Login
      - name: Railway Login
        run: railway login --token $RAILWAY_TOKEN
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # 4️⃣ Set Backend environment variables
      - name: Set Backend environment variables
        run: |
          railway variables set \
            ASPNETCORE_ENVIRONMENT=Production \
            DB_HOST=${{ vars.DB_HOST }} \
            DB_PORT=${{ vars.DB_PORT }} \
            DB_NAME=${{ vars.DB_NAME }} \
            DB_USER=${{ vars.DB_USER }} \
            DB_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}

      # 5️⃣ Deploy Backend Service
      - name: Deploy .NET Backend to Railway
        run: railway up --service backend


###################################################
# CD STAGE - DEPLOY TO DEV (ANSIBLE)
###################################################
  deploy-dev:
    name: Deploy to Dev (Local with Ansible)
    runs-on: [self-hosted, linux]
    needs:
      - dotnet-ci
      - react-ci
    if: ${{ inputs.environment == 'dev' }}
    environment: dev

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Run Ansible Playbook
      - name: Run Ansible Playbook
        run: |
          ansible-playbook playbook.yml \
            -e github_actor=${{ github.actor }} \
            -e github_token=${{ secrets.GITHUB_TOKEN }}
